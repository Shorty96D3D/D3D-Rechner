<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>D3D Business Manager Elite v3.1</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 10px; background: #121212; color: #e0e0e0; line-height: 1.4; margin-top: 20px; }
        .card { background: #1e1e1e; padding: 15px; border-radius: 12px; max-width: 600px; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }

        h2 { color: #007bff; text-align: center; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .section { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
        h3 { font-size: 14px; margin: 0 0 10px 0; color: #00d4ff; border-bottom: 1px solid #444; padding-bottom: 5px; }

        label { display: block; margin-top: 8px; font-size: 11px; color: #888; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; margin-top: 4px; border: 1px solid #444; border-radius: 6px; background: #121212; color: white; font-size: 15px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .grid-triple { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

        button { width: 100%; padding: 14px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; margin-top: 10px; cursor: pointer; transition: 0.2s; }
        .btn-calc { background: #6c757d; color: white; }
        .btn-order { background: #28a745; color: white; }
        .btn-add { background: #007bff; color: white; font-size: 13px; padding: 8px; }

        .inventory-item { background: #2a2a2a; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; font-size: 13px; border-left: 4px solid #007bff; transition: 0.3s; }
        .low-stock { background: #4a1a1a !important; border-left-color: #ff4444 !important; border: 1px solid #ff4444; }
        
        .item-info { flex-grow: 1; }
        .item-actions { display: flex; gap: 5px; align-items: center; }
        
        .icon-btn { border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; }
        .refill-btn { background-color: #007bff; }
        .settings-btn { background-color: #555; }
        .delete-btn { background-color: #ff4444; }

        .history-list { margin-top: 10px; max-height: 250px; overflow-y: auto; }
        .history-item { font-size: 12px; padding: 10px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #2a2a2a; margin-bottom: 4px; border-radius: 4px; }
        
        .total-box { margin-top: 15px; padding: 15px; background: #121212; border-radius: 8px; text-align: center; border: 1px solid #00d4ff; }
        .price-tag { font-size: 26px; color: #00d4ff; font-weight: bold; display: block; }
        .success-msg { color: #28a745; font-size: 12px; margin-top: 5px; font-weight: bold; display: none; text-align: center; }
    </style>
</head>
<body>

<div class="card">
    <h2>D3D Business Manager</h2>

    <div class="section">
        <h3>üì¶ Lagerbestand & Schwellenwerte</h3>
        <div id="inventory-list"></div>
        <div id="warehouse-value" style="font-size: 12px; color: #28a745; margin-top: 10px; text-align: right;">Warenwert: 0,00 ‚Ç¨</div>
        <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">
        
        <label>Neues Material Name:</label>
        <input type="text" id="new_name" placeholder="z.B. PLA Schwarz">
        
        <div class="grid-triple">
            <div><label>Preis (‚Ç¨/kg)</label><input type="number" id="new_price" step="0.01" placeholder="25.00"></div>
            <div><label>Bestand (g)</label><input type="number" id="new_stock" placeholder="1000"></div>
            <div><label>Warnwert (g)</label><input type="number" id="new_min" placeholder="200" value="150"></div>
        </div>
        <button class="btn-add" onclick="addMaterial()">+ Material hinzuf√ºgen</button>
    </div>

    <div class="section">
        <h3>üöÄ Projekt-Kalkulation</h3>
        <label>Projektname / Kunde:</label>
        <input type="text" id="calc_project_name" placeholder="z.B. Huber - Rahmenhalter">

        <label>Materialien (bis zu 4):</label>
        <div class="grid" style="margin-bottom: 5px;">
            <select id="mat_0"></select>
            <input type="number" id="gram_0" placeholder="Gramm">
        </div>
        <div class="grid" style="margin-bottom: 5px;">
            <select id="mat_1"></select>
            <input type="number" id="gram_1" placeholder="Gramm">
        </div>
        <div class="grid" style="margin-bottom: 5px;">
            <select id="mat_2"></select>
            <input type="number" id="gram_2" placeholder="Gramm">
        </div>
        <div class="grid">
            <select id="mat_3"></select>
            <input type="number" id="gram_3" placeholder="Gramm">
        </div>

        <div class="grid">
            <div><label>Druckzeit (h)</label><input type="number" id="calc_h" placeholder="4"></div>
            <div><label>Arbeit (min)</label><input type="number" id="calc_min" placeholder="15"></div>
        </div>
        <label>Stundenlohn (‚Ç¨/h)</label>
        <input type="number" id="calc_wage" value="30">

        <button class="btn-calc" onclick="calculate(false)">Nur Preis berechnen</button>
        <button class="btn-order" onclick="calculate(true)">Auftrag best√§tigen & Abbuchen</button>
        <div id="order-success" class="success-msg">‚úÖ Auftrag gebucht & Best√§nde korrigiert!</div>
    </div>

    <div id="res" class="total-box" style="display:none;">
        <span style="color: #888; font-size: 12px;">GESAMT-ANGEBOTSPREIS:</span>
        <span id="total_price" class="price-tag">0,00 ‚Ç¨</span>
    </div>

    <div class="section">
        <h3>üìú Historie</h3>
        <div id="history-list" class="history-list">
            <div style="color: #666; font-size: 12px; text-align: center; padding: 10px;">Noch keine Eintr√§ge.</div>
        </div>
        <button onclick="clearHistory()" style="background: none; color: #ff4444; font-size: 10px; padding: 5px; margin-top: 10px; width: auto; font-weight: normal;">Historie l√∂schen</button>
    </div>
</div>

<script>
    let inventory = JSON.parse(localStorage.getItem('d3d_inv')) || [];
    let history = JSON.parse(localStorage.getItem('d3d_history')) || [];

    function updateUI() {
        const list = document.getElementById('inventory-list');
        const selects = [document.getElementById('mat_0'), document.getElementById('mat_1'), document.getElementById('mat_2'), document.getElementById('mat_3')];
        const histList = document.getElementById('history-list');
        
        list.innerHTML = '';
        selects.forEach(s => s.innerHTML = '<option value="">-- W√§hlen --</option>');
        
        let totalVal = 0;

        inventory.forEach((item, index) => {
            const minVal = item.minStock || 150; // Standard 150g wenn nichts gesetzt
            const isLow = item.stock < minVal;

            const div = document.createElement('div');
            div.className = 'inventory-item' + (isLow ? ' low-stock' : '');
            div.innerHTML = `
                <div class="item-info">
                    <strong>${item.name}</strong><br>
                    ${item.stock}g / <small style="color:#aaa">Limit: ${minVal}g</small> (${item.price}‚Ç¨/kg)
                </div>
                <div class="item-actions">
                    <button class="icon-btn refill-btn" onclick="refillItem(${index})" title="Bestand hinzuf√ºgen">+</button>
                    <button class="icon-btn settings-btn" onclick="editThreshold(${index})" title="Warnwert √§ndern">‚öôÔ∏è</button>
                    <button class="icon-btn delete-btn" onclick="deleteItem(${index})" title="L√∂schen">X</button>
                </div>`;
            list.appendChild(div);

            selects.forEach(s => s.options.add(new Option(`${item.name} (${item.stock}g)`, index)));
            totalVal += (item.stock / 1000) * item.price;
        });

        if (history.length > 0) {
            histList.innerHTML = '';
            history.slice().reverse().forEach(entry => {
                const hDiv = document.createElement('div');
                hDiv.className = 'history-item';
                hDiv.innerHTML = `<div><strong>${entry.project || 'Unbenanntes Projekt'}</strong><br><span style="font-size:10px; color:#aaa">${entry.mat}</span><br><span style="font-size:10px; color:#888">${entry.date}</span></div>
                                  <div style="color: #00d4ff; font-weight: bold;">${entry.price}</div>`;
                histList.appendChild(hDiv);
            });
        }

        document.getElementById('warehouse-value').innerText = `Warenwert Lager: ${totalVal.toFixed(2)} ‚Ç¨`;
        localStorage.setItem('d3d_inv', JSON.stringify(inventory));
        localStorage.setItem('d3d_history', JSON.stringify(history));
    }

    function addMaterial() {
        const name = document.getElementById('new_name').value;
        const price = parseFloat(document.getElementById('new_price').value);
        const stock = parseFloat(document.getElementById('new_stock').value);
        const min = parseFloat(document.getElementById('new_min').value);
        
        if(name && !isNaN(price)) {
            inventory.push({
                name, 
                price, 
                stock: stock || 0, 
                minStock: min || 150
            });
            document.getElementById('new_name').value = '';
            document.getElementById('new_price').value = '';
            document.getElementById('new_stock').value = '';
            document.getElementById('new_min').value = '150';
            updateUI();
        }
    }

    function editThreshold(index) {
        const current = inventory[index].minStock || 150;
        const newVal = prompt(`Ab wie viel Gramm soll ${inventory[index].name} rot markiert werden?`, current);
        if (newVal !== null) {
            inventory[index].minStock = parseFloat(newVal);
            updateUI();
        }
    }

    function refillItem(index) {
        const amount = prompt(`Menge f√ºr ${inventory[index].name} (g) hinzuf√ºgen:`, "1000");
        if (amount) { inventory[index].stock += parseFloat(amount); updateUI(); }
    }

    function deleteItem(index) {
        if(confirm("Material unwiderruflich l√∂schen?")) { inventory.splice(index, 1); updateUI(); }
    }

    function calculate(doDeduct) {
        let matCosts = 0;
        let usedMatsInfo = [];
        let deductionList = [];

        for(let i=0; i<4; i++) {
            const idx = document.getElementById(`mat_${i}`).value;
            const gram = parseFloat(document.getElementById(`gram_${i}`).value) || 0;
            if(idx !== "" && gram > 0) {
                const mat = inventory[idx];
                matCosts += (gram / 1000
