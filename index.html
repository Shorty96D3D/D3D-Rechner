<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>D3D Business Manager Elite</title>
    <style>
        body { font-family: -apple-system, sans-serif; padding: 10px; background: #121212; color: #e0e0e0; line-height: 1.4; }
        .card { background: #1e1e1e; padding: 15px; border-radius: 12px; max-width: 600px; margin: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        h2 { color: #007bff; text-align: center; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .section { background: #252525; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
        h3 { font-size: 14px; margin: 0 0 10px 0; color: #00d4ff; border-bottom: 1px solid #444; padding-bottom: 5px; }
        label { display: block; margin-top: 8px; font-size: 11px; color: #888; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; margin-top: 4px; border: 1px solid #444; border-radius: 6px; background: #121212; color: white; font-size: 15px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        button { width: 100%; padding: 14px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; margin-top: 10px; cursor: pointer; transition: 0.2s; }
        .btn-calc { background: #6c757d; color: white; }
        .btn-order { background: #28a745; color: white; }
        .btn-add { background: #007bff; font-size: 13px; padding: 8px; }
        
        .inventory-item { 
            background: #2a2a2a; 
            padding: 10px; 
            border-radius: 8px; 
            margin-bottom: 8px; 
            display: flex; 
            align-items: center; 
            font-size: 13px; 
            border-left: 4px solid #007bff; 
        }
        
        .item-info { flex-grow: 1; }
        .low-stock { border-left: 4px solid #ff4444 !important; }
        .low-stock-text { color: #ff4444; font-weight: bold; }
        
        .item-actions { display: flex; gap: 8px; align-items: center; }
        .refill-btn { background-color: #007bff; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .delete-btn { background-color: #ff4444 !important; color: white !important; font-weight: bold; border: none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        
        /* Historie Styles */
        .history-list { margin-top: 10px; max-height: 200px; overflow-y: auto; }
        .history-item { font-size: 12px; padding: 8px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .history-item:last-child { border-bottom: none; }
        .history-date { color: #888; font-size: 10px; }

        .total-box { margin-top: 15px; padding: 15px; background: #121212; border-radius: 8px; text-align: center; border: 1px solid #00d4ff; }
        .price-tag { font-size: 26px; color: #00d4ff; font-weight: bold; display: block; }
        .success-msg { color: #28a745; font-size: 12px; margin-top: 5px; font-weight: bold; display: none; }
        .support-label { color: #e67e22 !important; }
    </style>
</head>
<body>
    <div class="card">
        <h2>D3D Business Manager</h2>

        <div class="section">
            <h3>ðŸ“¦ Lagerbestand & Warenwert</h3>
            <div id="inventory-list"></div>
            <div id="warehouse-value" style="font-size: 12px; color: #28a745; margin-top: 10px; text-align: right;">Warenwert: 0,00 â‚¬</div>
            <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">
            <label>Neues Material Name:</label>
            <input type="text" id="new_name" placeholder="z.B. PLA Schwarz">
            <div class="grid">
                <div><label>Preis (â‚¬/kg)</label><input type="number" id="new_price" step="0.01" placeholder="25.00"></div>
                <div><label>Bestand (gramm)</label><input type="number" id="new_stock" placeholder="1000"></div>
            </div>
            <button class="btn-add" onclick="addMaterial()">+ Material hinzufÃ¼gen</button>
        </div>

        <div class="section">
            <h3>ðŸš€ Kombi-Kalkulation</h3>
            
            <label>Hauptmaterial:</label>
            <select id="calc_mat_select"></select>
            <label>Verbrauch Hauptmaterial (gramm):</label>
            <input type="number" id="calc_g" placeholder="z.B. 85">

            <label class="support-label">Material 2 (z.B.-Support):</label>
            <select id="calc_support_select"></select>
            <label class="support-label">Verbrauch (gramm):</label>
            <input type="number" id="calc_support_g" placeholder="0" value="0">

            <label class="support-label">Material 3:</label>
            <select id="calc_support_select"></select>
            <label class="support-label">Verbrauch (gramm):</label>
            <input type="number" id="calc_support_g" placeholder="0" value="0">

            <label class="support-label">Material 4:</label>
            <select id="calc_support_select"></select>
            <label class="support-label">Verbrauch (gramm):</label>
            <input type="number" id="calc_support_g" placeholder="0" value="0">

            <div class="grid">
                <div><label>Druckzeit Gesamt (h)</label><input type="number" id="calc_h" placeholder="4"></div>
                <div><label>Arbeitszeit (min)</label><input type="number" id="calc_min" placeholder="15"></div>
            </div>
            <label>Stundenlohn (â‚¬/h)</label>
            <input type="number" id="calc_wage" value="20">
            
            <button class="btn-calc" onclick="calculate(false)">Nur Preis berechnen</button>
            <button class="btn-order" onclick="calculate(true)">Auftrag bestÃ¤tigen & Abbuchen</button>
            <div id="order-success" class="success-msg">âœ… BestÃ¤nde wurden abgebucht!</div>
        </div>

        <div id="res" class="total-box" style="display:none;">
            <span style="color: #888; font-size: 12px;">GESAMT-ANGEBOTSPREIS:</span>
            <span id="total_price" class="price-tag">0,00 â‚¬</span>
        </div>

        <div class="section">
            <h3>ðŸ“œ Letzte AuftrÃ¤ge</h3>
            <div id="history-list" class="history-list">
                <div style="color: #666; font-size: 12px; text-align: center; padding: 10px;">Noch keine AuftrÃ¤ge gebucht.</div>
            </div>
            <button onclick="clearHistory()" style="background: none; color: #ff4444; font-size: 10px; padding: 5px; margin-top: 10px; width: auto; font-weight: normal;">Historie lÃ¶schen</button>
        </div>
    </div>

    <script>
        let inventory = JSON.parse(localStorage.getItem('d3d_inv')) || [];
        let history = JSON.parse(localStorage.getItem('d3d_history')) || [];

        function updateUI() {
            const list = document.getElementById('inventory-list');
            const mainSelect = document.getElementById('calc_mat_select');
            const supportSelect = document.getElementById('calc_support_select');
            const histList = document.getElementById('history-list');
            
            list.innerHTML = '';
            mainSelect.innerHTML = '';
            supportSelect.innerHTML = '<option value="">-- Kein Support --</option>';
            
            let totalVal = 0;

            // Lagerliste & Dropdowns
            inventory.forEach((item, index) => {
                const isLow = item.stock < 100;
                const div = document.createElement('div');
                div.className = 'inventory-item' + (isLow ? ' low-stock' : '');
                div.innerHTML = `
                    <div class="item-info">
                        <strong class="${isLow ? 'low-stock-text' : ''}">${item.name}</strong><br>
                        ${item.stock}g (${item.price}â‚¬/kg)
                    </div>
                    <div class="item-actions">
                        <button class="refill-btn" onclick="refillItem(${index})">+</button>
                        <button class="delete-btn" onclick="deleteItem(${index})">X</button>
                    </div>
                `;
                list.appendChild(div);

                const optText = `${item.name} (${item.stock}g)`;
                mainSelect.options.add(new Option(optText, index));
                supportSelect.options.add(new Option(optText, index));

                totalVal += (item.stock / 1000) * item.price;
            });

            // Historie Liste
            if (history.length > 0) {
                histList.innerHTML = '';
                history.slice().reverse().forEach(entry => {
                    const hDiv = document.createElement('div');
                    hDiv.className = 'history-item';
                    hDiv.innerHTML = `
                        <div>
                            <strong>${entry.mat}</strong><br>
                            <span class="history-date">${entry.date}</span>
                        </div>
                        <div style="color: #00d4ff; font-weight: bold;">${entry.price}</div>
                    `;
                    histList.appendChild(hDiv);
                });
            }

            document.getElementById('warehouse-value').innerText = `Warenwert Lager: ${totalVal.toFixed(2)} â‚¬`;
            localStorage.setItem('d3d_inv', JSON.stringify(inventory));
            localStorage.setItem('d3d_history', JSON.stringify(history));
        }

        function addMaterial() {
            const name = document.getElementById('new_name').value;
            const price = parseFloat(document.getElementById('new_price').value);
            const stock = parseFloat(document.getElementById('new_stock').value);
            if(name && !isNaN(price) && !isNaN(stock)) {
                inventory.push({name, price, stock});
                document.getElementById('new_name').value = '';
                document.getElementById('new_price').value = '';
                document.getElementById('new_stock').value = '';
                updateUI();
            }
        }

        function refillItem(index) {
            const amount = prompt(`Menge hinzufÃ¼gen fÃ¼r "${inventory[index].name}" (in Gramm):`, "1000");
            if (amount !== null && !isNaN(amount)) {
                inventory[index].stock += parseFloat(amount);
                updateUI();
            }
        }

        function deleteItem(index) {
            if(confirm(`"${inventory[index].name}" wirklich lÃ¶schen?`)) {
                inventory.splice(index, 1);
                updateUI();
            }
        }

        function clearHistory() {
            if(confirm("Gesamte Historie lÃ¶schen?")) {
                history = [];
                updateUI();
            }
        }

        function calculate(doDeduct) {
            const mainIdx = document.getElementById('calc_mat_select').value;
            const supportIdx = document.getElementById('calc_support_select').value;
            
            if(mainIdx === "") return alert("Bitte Hauptmaterial wÃ¤hlen!");

            const mainMat = inventory[mainIdx];
            const mainG = parseFloat(document.getElementById('calc_g').value) || 0;
            const supportG = parseFloat(document.getElementById('calc_support_g').value) || 0;
            const h = parseFloat(document.getElementById('calc_h').value) || 0;
            const min = parseFloat(document.getElementById('calc_min').value) || 0;
            const wage = parseFloat(document.getElementById('calc_wage').value) || 30;

            let matCosts = (mainG / 1000) * mainMat.price;
            if(supportIdx !== "") {
                matCosts += (supportG / 1000) * inventory[supportIdx].price;
            }

            let energy = h * 0.15 * 0.40; 
            let wear = h * 0.60; 
            let labor = (min / 60) * wage;
            let total = (matCosts + energy + wear + labor) * 1.15;

            const formattedPrice = total.toLocaleString('de-DE', {style:'currency', currency:'EUR'});
            document.getElementById('total_price').innerText = formattedPrice;
            document.getElementById('res').style.display = 'block';

            if(doDeduct) {
                // Abbuchen
                inventory[mainIdx].stock = Math.max(0, inventory[mainIdx].stock - mainG);
                if(supportIdx !== "") {
                    inventory[supportIdx].stock = Math.max(0, inventory[supportIdx].stock - supportG);
                }
                
                // Historie speichern
                const now = new Date();
                history.push({
                    mat: mainMat.name,
                    price: formattedPrice,
                    date: now.toLocaleDateString('de-DE') + ' ' + now.toLocaleTimeString('de-DE', {hour: '2-digit', minute:'2-digit'})
                });
                
                // Nur die letzten 20 AuftrÃ¤ge behalten
                if(history.length > 20) history.shift();

                updateUI();
                const msg = document.getElementById('order-success');
                msg.style.display = 'block';
                setTimeout(() => { msg.style.display = 'none'; }, 3000);
            }
        }

        window.onload = updateUI;
    </script>
</body>
</html>

